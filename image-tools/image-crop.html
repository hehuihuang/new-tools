<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡è£å‰ª - å›¾ç‰‡å·¥å…·å¥—ä»¶</title>
    <link rel="stylesheet" href="./shared/styles.css">
    <script src="./shared/utils.js"></script>
    <script src="./shared/components.js"></script>
    <style>
        /* å¯¼èˆªæ æ ·å¼ */
        .nav-bar {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0;
            margin-bottom: 20px;
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .nav-item {
            position: relative;
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .nav-item:hover {
            background: #f5f5f5;
        }
        .nav-item > a {
            text-decoration: none;
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }
        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 1000;
            border-radius: 4px;
            padding: 8px 0;
        }
        .nav-item:hover .dropdown {
            display: block;
        }
        .dropdown a {
            display: block;
            padding: 10px 20px;
            color: #333;
            text-decoration: none;
            transition: background 0.2s;
            font-size: 14px;
        }
        .dropdown a:hover {
            background: #f0f0f0;
        }
        #crop-canvas { border: 1px solid #ddd; cursor: crosshair; max-width: 100%; }
        .crop-box { position: absolute; border: 2px dashed #4a90e2; background: rgba(74, 144, 226, 0.1); }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="nav-bar">
        <div class="nav-container">
            <div class="nav-item">
                <a href="../image-tools/index.html">å›¾ç‰‡å¤„ç†å·¥å…·</a>
                <div class="dropdown">
                    <a href="../image-tools/image-compress.html">å›¾ç‰‡å‹ç¼©</a>
                    <a href="../image-tools/image-rotate.html">æ—‹è½¬ç¿»è½¬</a>
                    <a href="../image-tools/image-convert.html">æ ¼å¼è½¬æ¢</a>
                    <a href="../image-tools/image-watermark.html">æ·»åŠ æ°´å°</a>
                    <a href="../image-tools/image-resize.html">å°ºå¯¸è°ƒæ•´</a>
                    <a href="../image-tools/image-merge.html">å›¾ç‰‡æ‹¼æ¥</a>
                    <a href="../image-tools/image-crop.html">å›¾ç‰‡è£å‰ª</a>
                    <a href="../image-tools/image-exif.html">EXIFæ¸…ç†</a>
                </div>
            </div>
            <div class="nav-item">
                <a href="../pdf-tools/pdf-preview.html">PDFå·¥å…·</a>
                <div class="dropdown">
                    <a href="../pdf-tools/pdf-merge.html">PDFåˆå¹¶</a>
                    <a href="../pdf-tools/pdf-split.html">PDFæ‹†åˆ†</a>
                    <a href="../pdf-tools/pdf-compress.html">PDFå‹ç¼©</a>
                    <a href="../pdf-tools/pdf-watermark.html">æ·»åŠ æ°´å°</a>
                    <a href="../pdf-tools/pdf-to-image.html">PDFè½¬å›¾ç‰‡</a>
                    <a href="../pdf-tools/pdf-reorder.html">é¡µé¢é‡æ’</a>
                    <a href="../pdf-tools/pdf-annotate.html">PDFæ ‡æ³¨</a>
                    <a href="../pdf-tools/pdf-preview.html">PDFé¢„è§ˆ</a>
                </div>
            </div>
            <div class="nav-item">
                <a href="../json-tools/json-formatter.html">JSONå·¥å…·</a>
                <div class="dropdown">
                    <a href="../json-tools/json-formatter.html">JSONæ ¼å¼åŒ–</a>
                    <a href="../json-tools/json-validator.html">JSONéªŒè¯</a>
                    <a href="../json-tools/json-diff.html">JSONå¯¹æ¯”</a>
                    <a href="../json-tools/json-csv-converter.html">JSON/CSVè½¬æ¢</a>
                    <a href="../json-tools/json-xml-converter.html">JSON/XMLè½¬æ¢</a>
                    <a href="../json-tools/json-schema.html">JSON Schema</a>
                </div>
            </div>
            <div class="nav-item">
                <a href="../code-tools/json-tools.html">ä»£ç æ ¼å¼è½¬æ¢å·¥å…·</a>
                <div class="dropdown">
                    <a href="../code-tools/base64-image.html">Base64å›¾ç‰‡</a>
                    <a href="../code-tools/url-codec.html">URLç¼–è§£ç </a>
                    <a href="../code-tools/jwt-parser.html">JWTè§£æ</a>
                    <a href="../code-tools/markdown-html.html">Markdown/HTML</a>
                    <a href="../code-tools/table-converter.html">è¡¨æ ¼è½¬æ¢</a>
                    <a href="../code-tools/text-diff.html">æ–‡æœ¬å¯¹æ¯”</a>
                </div>
            </div>
            <div class="nav-item">
                <a href="../text-tools/text-clean.html">æ–‡æœ¬æ•°å­—å·¥å…·</a>
                <div class="dropdown">
                    <a href="../text-tools/text-clean.html">æ–‡æœ¬æ¸…ç†</a>
                    <a href="../text-tools/text-replace.html">æ–‡æœ¬æ›¿æ¢</a>
                    <a href="../text-tools/text-split.html">æ–‡æœ¬åˆ†å‰²</a>
                    <a href="../text-tools/text-sort.html">æ–‡æœ¬æ’åº</a>
                    <a href="../text-tools/text-dedup.html">æ–‡æœ¬å»é‡</a>
                    <a href="../text-tools/text-stats.html">æ–‡æœ¬ç»Ÿè®¡</a>
                    <a href="../text-tools/random-gen.html">éšæœºç”Ÿæˆ</a>
                    <a href="../text-tools/emoji-convert.html">Emojiè½¬æ¢</a>
                </div>
            </div>
            <div class="nav-item">
                <a href="../finance-tools/salary-tax.html">è´¢ç¨å·¥å…·</a>
                <div class="dropdown">
                    <a href="../finance-tools/salary-tax.html">å·¥èµ„ä¸ªç¨</a>
                    <a href="../finance-tools/income-tax.html">ç»¼åˆæ‰€å¾—ä¸ªç¨</a>
                    <a href="../finance-tools/bonus-tax.html">å¹´ç»ˆå¥–ä¸ªç¨</a>
                    <a href="../finance-tools/corp-tax.html">ä¼ä¸šæ‰€å¾—ç¨</a>
                    <a href="../finance-tools/vat-calculator.html">å¢å€¼ç¨è®¡ç®—</a>
                    <a href="../finance-tools/mortgage.html">æˆ¿è´·è®¡ç®—</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <a href="../tooles/index.html" class="back-link">â† è¿”å›å·¥å…·ç®±</a>
            <h1>å›¾ç‰‡è£å‰ª</h1>
            <div class="privacy-notice">ğŸ”’ æ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ åˆ°æœåŠ¡å™¨</div>
        </div>

        <div class="card" id="upload-section">
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">ğŸ–¼ï¸</div>
                <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</h3>
            </div>
        </div>

        <div class="card" id="process-section" style="display: none;">
            <div class="input-group">
                <label>è£å‰ªæ¯”ä¾‹</label>
                <select id="ratio-select">
                    <option value="free">è‡ªç”±</option>
                    <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                    <option value="4:3">4:3</option>
                    <option value="16:9">16:9</option>
                </select>
            </div>
            
            <div style="position: relative; display: inline-block; margin: 20px 0;">
                <canvas id="crop-canvas"></canvas>
            </div>
            
            <p id="crop-info" style="color: #666; font-size: 14px;"></p>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" id="crop-btn">è£å‰ªå›¾ç‰‡</button>
                <button class="btn btn-secondary" id="reset-btn" style="margin-left: 10px;">é‡æ–°ä¸Šä¼ </button>
            </div>

            <div id="result-section" style="display: none; margin-top: 30px;">
                <h3>è£å‰ªç»“æœ</h3>
                <div class="image-viewer">
                    <canvas id="result-canvas"></canvas>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" id="download-btn">ä¸‹è½½å›¾ç‰‡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ImageCropTool {
            constructor() {
                this.uploader = new ImageUploader({ multiple: false });
                this.progress = new ProgressIndicator();
                this.canvas = null;
                this.cropArea = { x: 0, y: 0, width: 0, height: 0 };
                this.isDragging = false;
                this.startX = 0;
                this.startY = 0;
                
                this._initElements();
                this._bindEvents();
            }

            _initElements() {
                this.uploadArea = document.getElementById('upload-area');
                this.uploadSection = document.getElementById('upload-section');
                this.processSection = document.getElementById('process-section');
                this.cropCanvas = document.getElementById('crop-canvas');
                this.ratioSelect = document.getElementById('ratio-select');
                this.cropInfo = document.getElementById('crop-info');
                this.resultSection = document.getElementById('result-section');
                this.resultCanvas = document.getElementById('result-canvas');
            }

            _bindEvents() {
                this.uploadArea.addEventListener('click', () => {
                    this.uploader.selectFiles().then(files => this.loadImage(files[0])).catch(err => {});
                });

                this.uploader.setupDropZone(this.uploadArea, (files) => this.loadImage(files[0]));

                // é¼ æ ‡äº‹ä»¶
                this.cropCanvas.addEventListener('mousedown', (e) => this.startCrop(e));
                this.cropCanvas.addEventListener('mousemove', (e) => this.updateCrop(e));
                this.cropCanvas.addEventListener('mouseup', () => this.endCrop());

                document.getElementById('crop-btn').addEventListener('click', () => this.cropImage());
                document.getElementById('reset-btn').addEventListener('click', () => this.reset());
                document.getElementById('download-btn').addEventListener('click', () => this.downloadImage());
            }

            async loadImage(file) {
                try {
                    this.progress.show('åŠ è½½å›¾ç‰‡...');
                    
                    this.originalFile = file;
                    const dataURL = await this.uploader.readAsDataURL(file);
                    const img = await Utils.loadImageToCanvas(dataURL, this.cropCanvas);
                    
                    // é»˜è®¤é€‰æ‹©æ•´ä¸ªå›¾ç‰‡
                    this.cropArea = { x: 0, y: 0, width: img.width, height: img.height };
                    this.updateCropInfo();
                    
                    this.uploadSection.style.display = 'none';
                    this.processSection.style.display = 'block';
                    this.resultSection.style.display = 'none';
                    
                    this.progress.hide();
                    Utils.showSuccess('å›¾ç‰‡åŠ è½½æˆåŠŸï¼æ‹–åŠ¨é¼ æ ‡é€‰æ‹©è£å‰ªåŒºåŸŸ');
                } catch (error) {
                    this.progress.hide();
                    Utils.showError('å›¾ç‰‡åŠ è½½å¤±è´¥: ' + error.message);
                }
            }

            startCrop(e) {
                const rect = this.cropCanvas.getBoundingClientRect();
                this.startX = e.clientX - rect.left;
                this.startY = e.clientY - rect.top;
                this.isDragging = true;
            }

            updateCrop(e) {
                if (!this.isDragging) return;
                
                const rect = this.cropCanvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                this.cropArea.x = Math.min(this.startX, currentX);
                this.cropArea.y = Math.min(this.startY, currentY);
                this.cropArea.width = Math.abs(currentX - this.startX);
                this.cropArea.height = Math.abs(currentY - this.startY);
                
                // åº”ç”¨æ¯”ä¾‹çº¦æŸ
                const ratio = this.ratioSelect.value;
                if (ratio !== 'free') {
                    const [w, h] = ratio.split(':').map(Number);
                    this.cropArea.height = this.cropArea.width * h / w;
                }
                
                this.drawCropOverlay();
                this.updateCropInfo();
            }

            endCrop() {
                this.isDragging = false;
            }

            drawCropOverlay() {
                const ctx = this.cropCanvas.getContext('2d');
                const img = new Image();
                img.src = this.cropCanvas.toDataURL();
                img.onload = () => {
                    ctx.clearRect(0, 0, this.cropCanvas.width, this.cropCanvas.height);
                    ctx.drawImage(img, 0, 0);
                    
                    // ç»˜åˆ¶åŠé€æ˜é®ç½©
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.fillRect(0, 0, this.cropCanvas.width, this.cropCanvas.height);
                    
                    // æ¸…é™¤è£å‰ªåŒºåŸŸ
                    ctx.clearRect(this.cropArea.x, this.cropArea.y, this.cropArea.width, this.cropArea.height);
                    ctx.drawImage(img, this.cropArea.x, this.cropArea.y, this.cropArea.width, this.cropArea.height,
                                  this.cropArea.x, this.cropArea.y, this.cropArea.width, this.cropArea.height);
                    
                    // ç»˜åˆ¶è¾¹æ¡†
                    ctx.strokeStyle = '#4a90e2';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(this.cropArea.x, this.cropArea.y, this.cropArea.width, this.cropArea.height);
                };
            }

            updateCropInfo() {
                this.cropInfo.textContent = `è£å‰ªåŒºåŸŸ: ${Math.round(this.cropArea.width)} Ã— ${Math.round(this.cropArea.height)}`;
            }

            async cropImage() {
                try {
                    this.progress.show('è£å‰ªå›¾ç‰‡...');
                    
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = this.cropArea.width;
                    tempCanvas.height = this.cropArea.height;
                    
                    const ctx = tempCanvas.getContext('2d');
                    ctx.drawImage(this.cropCanvas, 
                        this.cropArea.x, this.cropArea.y, this.cropArea.width, this.cropArea.height,
                        0, 0, this.cropArea.width, this.cropArea.height);
                    
                    this.resultCanvas.width = this.cropArea.width;
                    this.resultCanvas.height = this.cropArea.height;
                    const resultCtx = this.resultCanvas.getContext('2d');
                    resultCtx.drawImage(tempCanvas, 0, 0);
                    
                    this.croppedBlob = await Utils.canvasToBlob(tempCanvas, 'image/png');
                    this.resultSection.style.display = 'block';
                    
                    this.progress.hide();
                    Utils.showSuccess('å›¾ç‰‡è£å‰ªå®Œæˆï¼');
                } catch (error) {
                    this.progress.hide();
                    Utils.showError('å›¾ç‰‡è£å‰ªå¤±è´¥: ' + error.message);
                }
            }

            downloadImage() {
                if (this.croppedBlob) {
                    const fileName = this.originalFile.name.replace(/\.[^/.]+$/, '') + '-cropped.png';
                    Utils.downloadFile(this.croppedBlob, fileName);
                    Utils.showSuccess('ä¸‹è½½æˆåŠŸï¼');
                }
            }

            reset() {
                this.uploadSection.style.display = 'block';
                this.processSection.style.display = 'none';
                this.resultSection.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new ImageCropTool();
        });
    </script>
</body>
</html>
