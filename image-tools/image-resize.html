<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ºå¯¸è°ƒæ•´ - å›¾ç‰‡å·¥å…·å¥—ä»¶</title>
    <link rel="stylesheet" href="./shared/styles.css">
    <script src="./shared/utils.js"></script>
    <script src="./shared/components.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../tooles/index.html" class="back-link">â† è¿”å›å·¥å…·ç®±</a>
            <h1>å›¾ç‰‡å°ºå¯¸è°ƒæ•´</h1>
            <div class="privacy-notice">ğŸ”’ æ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ åˆ°æœåŠ¡å™¨</div>
        </div>

        <div class="card" id="upload-section">
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">ğŸ–¼ï¸</div>
                <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</h3>
            </div>
        </div>

        <div class="card" id="process-section" style="display: none;">
            <h3>åŸå§‹å°ºå¯¸: <span id="original-size"></span></h3>
            
            <div class="input-group">
                <label>
                    <input type="checkbox" id="maintain-ratio" checked> ä¿æŒå®½é«˜æ¯”
                </label>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="input-group">
                    <label>å®½åº¦ (px)</label>
                    <input type="number" id="width-input" min="1">
                </div>
                <div class="input-group">
                    <label>é«˜åº¦ (px)</label>
                    <input type="number" id="height-input" min="1">
                </div>
            </div>

            <div class="input-group">
                <label>æˆ–æŒ‰ç™¾åˆ†æ¯”ç¼©æ”¾</label>
                <input type="number" id="scale-input" min="1" max="500" placeholder="ä¾‹å¦‚: 50 è¡¨ç¤ºç¼©å°åˆ°50%">
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-primary" id="resize-btn">è°ƒæ•´å°ºå¯¸</button>
                <button class="btn btn-secondary" id="reset-btn" style="margin-left: 10px;">é‡æ–°ä¸Šä¼ </button>
            </div>

            <div id="result-section" style="display: none; margin-top: 30px;">
                <h3>è°ƒæ•´ç»“æœ</h3>
                <div class="image-viewer">
                    <canvas id="result-canvas"></canvas>
                </div>
                <div class="info" id="result-info" style="text-align: center; margin-top: 15px;"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" id="download-btn">ä¸‹è½½å›¾ç‰‡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ImageResizeTool {
            constructor() {
                this.uploader = new ImageUploader({ multiple: false });
                this.progress = new ProgressIndicator();
                this.originalCanvas = null;
                this.originalWidth = 0;
                this.originalHeight = 0;
                this.resizedBlob = null;
                
                this._initElements();
                this._bindEvents();
            }

            _initElements() {
                this.uploadArea = document.getElementById('upload-area');
                this.uploadSection = document.getElementById('upload-section');
                this.processSection = document.getElementById('process-section');
                this.originalSizeEl = document.getElementById('original-size');
                this.maintainRatio = document.getElementById('maintain-ratio');
                this.widthInput = document.getElementById('width-input');
                this.heightInput = document.getElementById('height-input');
                this.scaleInput = document.getElementById('scale-input');
                this.resultSection = document.getElementById('result-section');
                this.resultCanvas = document.getElementById('result-canvas');
            }

            _bindEvents() {
                this.uploadArea.addEventListener('click', () => {
                    this.uploader.selectFiles().then(files => this.loadImage(files[0])).catch(err => {});
                });

                this.uploader.setupDropZone(this.uploadArea, (files) => this.loadImage(files[0]));

                // å®½åº¦è¾“å…¥
                this.widthInput.addEventListener('input', () => {
                    if (this.maintainRatio.checked && this.widthInput.value) {
                        const width = parseInt(this.widthInput.value);
                        const height = Math.round(width / (this.originalWidth / this.originalHeight));
                        this.heightInput.value = height;
                    }
                    this.scaleInput.value = '';
                });

                // é«˜åº¦è¾“å…¥
                this.heightInput.addEventListener('input', () => {
                    if (this.maintainRatio.checked && this.heightInput.value) {
                        const height = parseInt(this.heightInput.value);
                        const width = Math.round(height * (this.originalWidth / this.originalHeight));
                        this.widthInput.value = width;
                    }
                    this.scaleInput.value = '';
                });

                // ç™¾åˆ†æ¯”è¾“å…¥
                this.scaleInput.addEventListener('input', () => {
                    if (this.scaleInput.value) {
                        const scale = parseInt(this.scaleInput.value) / 100;
                        this.widthInput.value = Math.round(this.originalWidth * scale);
                        this.heightInput.value = Math.round(this.originalHeight * scale);
                    }
                });

                document.getElementById('resize-btn').addEventListener('click', () => this.resizeImage());
                document.getElementById('reset-btn').addEventListener('click', () => this.reset());
                document.getElementById('download-btn').addEventListener('click', () => this.downloadImage());
            }

            async loadImage(file) {
                try {
                    this.progress.show('åŠ è½½å›¾ç‰‡...');
                    
                    const dataURL = await this.uploader.readAsDataURL(file);
                    const tempCanvas = document.createElement('canvas');
                    const img = await Utils.loadImageToCanvas(dataURL, tempCanvas);
                    
                    this.originalCanvas = tempCanvas;
                    this.originalWidth = img.width;
                    this.originalHeight = img.height;
                    this.originalFile = file;
                    
                    this.originalSizeEl.textContent = `${img.width} Ã— ${img.height}`;
                    this.widthInput.value = img.width;
                    this.heightInput.value = img.height;
                    
                    this.uploadSection.style.display = 'none';
                    this.processSection.style.display = 'block';
                    this.resultSection.style.display = 'none';
                    
                    this.progress.hide();
                    Utils.showSuccess('å›¾ç‰‡åŠ è½½æˆåŠŸï¼');
                } catch (error) {
                    this.progress.hide();
                    Utils.showError('å›¾ç‰‡åŠ è½½å¤±è´¥: ' + error.message);
                }
            }

            async resizeImage() {
                try {
                    this.progress.show('è°ƒæ•´å°ºå¯¸...');
                    
                    const width = parseInt(this.widthInput.value);
                    const height = parseInt(this.heightInput.value);
                    
                    if (!width || !height || width <= 0 || height <= 0) {
                        throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„å°ºå¯¸');
                    }
                    
                    const resizedCanvas = Utils.resizeCanvas(this.originalCanvas, width, height);
                    
                    this.resultCanvas.width = width;
                    this.resultCanvas.height = height;
                    const ctx = this.resultCanvas.getContext('2d');
                    ctx.drawImage(resizedCanvas, 0, 0);
                    
                    this.resizedBlob = await Utils.canvasToBlob(resizedCanvas, 'image/png');
                    
                    document.getElementById('result-info').textContent = 
                        `æ–°å°ºå¯¸: ${width} Ã— ${height} | å¤§å°: ${Utils.formatFileSize(this.resizedBlob.size)}`;
                    
                    this.resultSection.style.display = 'block';
                    
                    this.progress.hide();
                    Utils.showSuccess('å°ºå¯¸è°ƒæ•´å®Œæˆï¼');
                } catch (error) {
                    this.progress.hide();
                    Utils.showError('å°ºå¯¸è°ƒæ•´å¤±è´¥: ' + error.message);
                }
            }

            downloadImage() {
                if (this.resizedBlob) {
                    const fileName = this.originalFile.name.replace(/\.[^/.]+$/, '') + '-resized.png';
                    Utils.downloadFile(this.resizedBlob, fileName);
                    Utils.showSuccess('ä¸‹è½½æˆåŠŸï¼');
                }
            }

            reset() {
                this.uploadSection.style.display = 'block';
                this.processSection.style.display = 'none';
                this.resultSection.style.display = 'none';
                this.originalCanvas = null;
                this.resizedBlob = null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new ImageResizeTool();
        });
    </script>
</body>
</html>
