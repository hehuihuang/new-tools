<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF å‹ç¼© - PDF å·¥å…·å¥—ä»¶</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link rel="stylesheet" href="./shared/styles.css">
    <script src="./shared/utils.js"></script>
    <script src="./shared/components.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../tooles/index.html" class="back-link">â† è¿”å›å·¥å…·ç®±</a>
            <h1>PDF å‹ç¼©</h1>
            <div class="privacy-notice">ğŸ”’ æ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ åˆ°æœåŠ¡å™¨</div>
        </div>

        <div class="card" id="upload-section">
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">ğŸ“„</div>
                <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  PDF æ–‡ä»¶</h3>
            </div>
        </div>

        <div class="card" id="compress-section" style="display: none;">
            <h3>æ–‡ä»¶ä¿¡æ¯</h3>
            <p id="file-info"></p>
            
            <h3 style="margin-top: 20px;">å‹ç¼©è´¨é‡</h3>
            <div style="margin: 20px 0;">
                <label>
                    <input type="radio" name="quality" value="0.3"> ä½è´¨é‡ï¼ˆé«˜å‹ç¼©ï¼‰
                </label><br>
                <label>
                    <input type="radio" name="quality" value="0.7" checked> ä¸­ç­‰è´¨é‡ï¼ˆæ¨èï¼‰
                </label><br>
                <label>
                    <input type="radio" name="quality" value="0.9"> é«˜è´¨é‡ï¼ˆä½å‹ç¼©ï¼‰
                </label>
            </div>
            
            <button class="btn btn-primary" id="compress-btn">å‹ç¼© PDF</button>
            
            <div id="result-section" style="display: none; margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 4px;">
                <h3>å‹ç¼©ç»“æœ</h3>
                <p id="result-info"></p>
            </div>
        </div>
    </div>

    <script>
        class PDFCompressTool {
            constructor() {
                this.uploader = new FileUploader({ multiple: false });
                this.progress = new ProgressIndicator();
                this.pdfDoc = null;
                this.originalSize = 0;
                this.file = null;
                
                this._initElements();
                this._bindEvents();
            }

            _initElements() {
                this.uploadArea = document.getElementById('upload-area');
                this.uploadSection = document.getElementById('upload-section');
                this.compressSection = document.getElementById('compress-section');
                this.fileInfo = document.getElementById('file-info');
                this.resultSection = document.getElementById('result-section');
                this.resultInfo = document.getElementById('result-info');
            }

            _bindEvents() {
                this.uploadArea.addEventListener('click', () => {
                    this.uploader.selectFiles().then(files => {
                        this.loadPDF(files[0]);
                    }).catch(err => {});
                });

                this.uploader.setupDropZone(this.uploadArea, (files) => {
                    this.loadPDF(files[0]);
                });

                document.getElementById('compress-btn').addEventListener('click', () => {
                    this.compressPDF();
                });
            }

            async loadPDF(file) {
                try {
                    this.progress.show('åŠ è½½ PDF...');
                    
                    this.file = file;
                    this.originalSize = file.size;
                    
                    const arrayBuffer = await this.uploader.readAsArrayBuffer(file);
                    this.pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                    
                    this.fileInfo.textContent = `æ–‡ä»¶å: ${file.name} | å¤§å°: ${Utils.formatFileSize(file.size)} | é¡µæ•°: ${this.pdfDoc.getPageCount()}`;
                    
                    this.uploadSection.style.display = 'none';
                    this.compressSection.style.display = 'block';
                    
                    this.progress.hide();
                    Utils.showSuccess('PDF åŠ è½½æˆåŠŸï¼');
                    
                } catch (error) {
                    this.progress.hide();
                    Utils.showError('PDF åŠ è½½å¤±è´¥: ' + error.message);
                }
            }

            async compressPDF() {
                try {
                    this.progress.show('å‹ç¼© PDF...');
                    
                    const quality = parseFloat(document.querySelector('input[name="quality"]:checked').value);
                    
                    // ä½¿ç”¨ Canvas é‡ç»˜æ–¹å¼è¿›è¡ŒçœŸå®å‹ç¼©
                    const arrayBuffer = await this.uploader.readAsArrayBuffer(this.file);
                    
                    // ä½¿ç”¨ PDF.js æ¸²æŸ“é¡µé¢
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    // åˆ›å»ºæ–°çš„ PDF æ–‡æ¡£
                    const newPdfDoc = await PDFLib.PDFDocument.create();
                    
                    const numPages = pdf.numPages;
                    
                    for (let i = 1; i <= numPages; i++) {
                        this.progress.update((i / numPages) * 100, `å‹ç¼©ç¬¬ ${i}/${numPages} é¡µ...`);
                        
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 });
                        
                        // åˆ›å»º canvas å¹¶æ¸²æŸ“
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        await page.render({
                            canvasContext: canvas.getContext('2d'),
                            viewport: viewport
                        }).promise;
                        
                        // å°† canvas è½¬æ¢ä¸ºå›¾ç‰‡ï¼Œåº”ç”¨å‹ç¼©è´¨é‡
                        const imageBlob = await new Promise(resolve => {
                            canvas.toBlob(resolve, 'image/jpeg', quality);
                        });
                        
                        // å°†å‹ç¼©åçš„å›¾ç‰‡åµŒå…¥æ–° PDF
                        const imageBytes = await imageBlob.arrayBuffer();
                        const image = await newPdfDoc.embedJpg(imageBytes);
                        
                        // æ·»åŠ é¡µé¢
                        const newPage = newPdfDoc.addPage([viewport.width, viewport.height]);
                        newPage.drawImage(image, {
                            x: 0,
                            y: 0,
                            width: viewport.width,
                            height: viewport.height
                        });
                    }
                    
                    // ä¿å­˜å‹ç¼©åçš„ PDF
                    const pdfBytes = await newPdfDoc.save({
                        useObjectStreams: true,
                        addDefaultPage: false
                    });
                    
                    const compressedSize = pdfBytes.length;
                    const ratio = ((this.originalSize - compressedSize) / this.originalSize * 100).toFixed(1);
                    
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    Utils.downloadFile(blob, 'compressed.pdf');
                    
                    this.resultInfo.textContent = `åŸå§‹å¤§å°: ${Utils.formatFileSize(this.originalSize)} | å‹ç¼©å: ${Utils.formatFileSize(compressedSize)} | å‹ç¼©ç‡: ${ratio}%`;
                    this.resultSection.style.display = 'block';
                    
                    this.progress.hide();
                    Utils.showSuccess('PDF å‹ç¼©å®Œæˆï¼');
                    
                } catch (error) {
                    this.progress.hide();
                    Utils.showError('PDF å‹ç¼©å¤±è´¥: ' + error.message);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new PDFCompressTool();
        });
    </script>
</body>
</html>
