<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF åœ¨çº¿é¢„è§ˆ - PDF å·¥å…·å¥—ä»¶</title>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // é…ç½® PDF.js - ç¦ç”¨å­˜å‚¨ä»¥é¿å… file:// åè®®é”™è¯¯
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    
    <!-- å…±äº«æ ·å¼ -->
    <link rel="stylesheet" href="./shared/styles.css">
    
    <!-- å…±äº«å·¥å…·å‡½æ•° -->
    <script src="./shared/utils.js"></script>
    
    <!-- å…±äº«ç»„ä»¶ -->
    <script src="./shared/components.js"></script>
    
    <style>
        .pdf-viewer-wrapper {
            position: relative;
            background: #525659;
            border-radius: 8px;
            padding: 20px;
        }
        
        .pdf-viewer {
            max-height: 70vh;
            overflow-y: auto;
            position: relative;
            scroll-behavior: smooth;
        }
        
        .page-wrapper {
            margin-bottom: 30px;
            position: relative;
            display: inline-block;
        }
        
        .page-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 10;
        }
        
        .pdf-page-canvas {
            display: block;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            background: white;
        }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar-container {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin-bottom: 15px;
            z-index: 100;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }
        
        .progress-info {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 101;
            pointer-events: none;
        }
        
        /* ç¾åŒ–æŒ‰é’® */
        .viewer-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .viewer-controls .btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .viewer-controls .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .viewer-controls .btn:active {
            transform: translateY(0);
        }
        
        .viewer-controls .page-info {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }
        
        .viewer-controls input[type="number"] {
            width: 70px;
            padding: 10px;
            border: 2px solid white;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            background: white;
            color: #667eea;
        }
        
        .viewer-controls input[type="number"]:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.2);
        }
        
        /* æ§åˆ¶æŒ‰é’®åˆ†ç»„ */
        .control-group {
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 5px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <a href="../tooles/index.html" class="back-link">â† è¿”å›å·¥å…·ç®±</a>
            <h1>PDF åœ¨çº¿é¢„è§ˆ</h1>
            <div class="privacy-notice">
                ğŸ”’ æ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ åˆ°æœåŠ¡å™¨
            </div>
        </div>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="card" id="upload-section">
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">ğŸ“„</div>
                <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  PDF æ–‡ä»¶</h3>
                <p>æ”¯æŒæœ€å¤§ 50MB çš„ PDF æ–‡ä»¶</p>
            </div>
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div class="card" id="preview-section" style="display: none;">
            <div class="pdf-viewer-wrapper">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="scroll-progress"></div>
                </div>
                <div class="progress-info" id="progress-info">0%</div>
                <div class="pdf-viewer" id="pdf-viewer"></div>
            </div>
            
            <div class="viewer-controls">
                <div class="control-group">
                    <button class="btn" id="prev-page">â¬…ï¸ ä¸Šä¸€é¡µ</button>
                    <span class="page-info" id="page-info">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                    <button class="btn" id="next-page">ä¸‹ä¸€é¡µ â¡ï¸</button>
                </div>
                
                <div class="control-group">
                    <input type="number" id="page-input" min="1" value="1">
                    <button class="btn" id="go-to-page">ğŸ¯ è·³è½¬</button>
                </div>
                
                <div class="control-group">
                    <button class="btn" id="zoom-out">ğŸ”â– ç¼©å°</button>
                    <button class="btn" id="zoom-in">ğŸ”â• æ”¾å¤§</button>
                    <button class="btn" id="fit-page">ğŸ“ é€‚åº”</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
    <div class="progress-overlay" id="progress-overlay">
        <div class="progress-content">
            <div class="progress-spinner"></div>
            <p class="progress-message">åŠ è½½ä¸­...</p>
        </div>
    </div>

    <script>
        // PDF é¢„è§ˆå·¥å…·ç±»
        class PDFPreviewTool {
            constructor() {
                this.uploader = new FileUploader({ multiple: false });
                this.progress = new ProgressIndicator();
                
                this._initElements();
                this._bindEvents();
            }

            _initElements() {
                this.uploadArea = document.getElementById('upload-area');
                this.uploadSection = document.getElementById('upload-section');
                this.previewSection = document.getElementById('preview-section');
                this.viewerContainer = document.getElementById('pdf-viewer');
                this.pageInfo = document.getElementById('page-info');
                this.pageInput = document.getElementById('page-input');
                this.scrollProgress = document.getElementById('scroll-progress');
                this.progressInfo = document.getElementById('progress-info');
                this.pdfDoc = null;
                this.currentPage = 1;
            }

            _bindEvents() {
                // ç‚¹å‡»ä¸Šä¼ 
                this.uploadArea.addEventListener('click', () => {
                    this.uploader.selectFiles().then(files => {
                        this.handleFileUpload(files[0]);
                    }).catch(err => {
                        if (err.message !== 'æ²¡æœ‰æœ‰æ•ˆçš„æ–‡ä»¶') {
                            Utils.showError(err.message);
                        }
                    });
                });

                // æ‹–æ‹½ä¸Šä¼ 
                this.uploader.setupDropZone(this.uploadArea, (files) => {
                    this.handleFileUpload(files[0]);
                });

                // æ»šåŠ¨è¿›åº¦æ¡
                this.viewerContainer.addEventListener('scroll', () => {
                    this._updateScrollProgress();
                });

                // é¡µé¢å¯¼èˆª
                document.getElementById('prev-page').addEventListener('click', () => {
                    this._scrollToPreviousPage();
                });

                document.getElementById('next-page').addEventListener('click', () => {
                    this._scrollToNextPage();
                });

                document.getElementById('go-to-page').addEventListener('click', () => {
                    const pageNum = parseInt(this.pageInput.value);
                    if (this.pdfDoc && pageNum >= 1 && pageNum <= this.pdfDoc.numPages) {
                        this._scrollToPage(pageNum);
                    }
                });

                // å›è½¦è·³è½¬
                this.pageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('go-to-page').click();
                    }
                });

                // ç¼©æ”¾æ§åˆ¶ - æš‚æ—¶ç¦ç”¨ï¼Œå› ä¸ºç°åœ¨æ˜¾ç¤ºæ‰€æœ‰é¡µé¢
                document.getElementById('zoom-in').addEventListener('click', () => {
                    Utils.showError('ç¼©æ”¾åŠŸèƒ½æš‚ä¸æ”¯æŒå¤šé¡µé¢„è§ˆæ¨¡å¼');
                });

                document.getElementById('zoom-out').addEventListener('click', () => {
                    Utils.showError('ç¼©æ”¾åŠŸèƒ½æš‚ä¸æ”¯æŒå¤šé¡µé¢„è§ˆæ¨¡å¼');
                });

                document.getElementById('fit-page').addEventListener('click', () => {
                    Utils.showError('ç¼©æ”¾åŠŸèƒ½æš‚ä¸æ”¯æŒå¤šé¡µé¢„è§ˆæ¨¡å¼');
                });
            }

            async handleFileUpload(file) {
                try {
                    this.progress.show('åŠ è½½ PDF æ–‡ä»¶...');

                    // è¯»å–æ–‡ä»¶
                    const arrayBuffer = await this.uploader.readAsArrayBuffer(file);

                    // æ¸…ç©ºå®¹å™¨
                    this.viewerContainer.innerHTML = '';

                    // é…ç½® PDF.js
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 
                        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

                    // åŠ è½½ PDF
                    const loadingTask = pdfjsLib.getDocument({ 
                        data: arrayBuffer,
                        disableAutoFetch: true,
                        disableStream: true
                    });
                    this.pdfDoc = await loadingTask.promise;

                    // æ¸²æŸ“æ‰€æœ‰é¡µé¢
                    for (let pageNum = 1; pageNum <= this.pdfDoc.numPages; pageNum++) {
                        this.progress.show(`åŠ è½½ç¬¬ ${pageNum}/${this.pdfDoc.numPages} é¡µ...`);
                        await this._renderPage(pageNum);
                    }

                    // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
                    this.uploadSection.style.display = 'none';
                    this.previewSection.style.display = 'block';

                    // æ›´æ–°é¡µé¢ä¿¡æ¯
                    this.currentPage = 1;
                    this._updatePageInfo();
                    
                    // åˆå§‹åŒ–æ»šåŠ¨è¿›åº¦
                    this._initScrollProgress();

                    this.progress.hide();
                    Utils.showSuccess(`PDF åŠ è½½æˆåŠŸï¼å…± ${this.pdfDoc.numPages} é¡µ`);

                } catch (error) {
                    this.progress.hide();
                    Utils.showError(error.message || 'PDF æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                    console.error('PDF åŠ è½½é”™è¯¯:', error);
                }
            }

            async _renderPage(pageNum) {
                const page = await this.pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 });

                // åˆ›å»ºé¡µé¢åŒ…è£…å™¨
                const pageWrapper = document.createElement('div');
                pageWrapper.className = 'page-wrapper';
                pageWrapper.dataset.pageNum = pageNum;

                // åˆ›å»ºé¡µç æ ‡ç­¾
                const pageLabel = document.createElement('div');
                pageLabel.className = 'page-number';
                pageLabel.textContent = `ç¬¬ ${pageNum} é¡µ`;
                pageWrapper.appendChild(pageLabel);

                // åˆ›å»º canvas
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page-canvas';
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                const ctx = canvas.getContext('2d');

                // æ¸²æŸ“ PDF é¡µé¢
                await page.render({ canvasContext: ctx, viewport }).promise;

                pageWrapper.appendChild(canvas);
                this.viewerContainer.appendChild(pageWrapper);
            }

            _updatePageInfo() {
                if (this.pdfDoc) {
                    const total = this.pdfDoc.numPages;
                    this.pageInfo.textContent = `ç¬¬ ${this.currentPage} é¡µ / å…± ${total} é¡µ`;
                    this.pageInput.value = this.currentPage;
                    this.pageInput.max = total;
                }
            }

            _updateScrollProgress() {
                const container = this.viewerContainer;
                const scrollTop = container.scrollTop;
                const scrollHeight = container.scrollHeight - container.clientHeight;
                
                if (scrollHeight > 0) {
                    const progress = (scrollTop / scrollHeight) * 100;
                    this.scrollProgress.style.width = progress + '%';
                    this.progressInfo.textContent = Math.round(progress) + '%';
                    
                    // æ ¹æ®æ»šåŠ¨ä½ç½®æ›´æ–°å½“å‰é¡µç 
                    this._updateCurrentPageByScroll();
                } else {
                    this.scrollProgress.style.width = '0%';
                    this.progressInfo.textContent = '0%';
                }
            }
            
            _updateCurrentPageByScroll() {
                const container = this.viewerContainer;
                const scrollTop = container.scrollTop;
                const pageWrappers = container.querySelectorAll('.page-wrapper');
                
                for (let i = 0; i < pageWrappers.length; i++) {
                    const wrapper = pageWrappers[i];
                    const rect = wrapper.getBoundingClientRect();
                    const containerRect = container.getBoundingClientRect();
                    
                    // å¦‚æœé¡µé¢åœ¨è§†å£ä¸­
                    if (rect.top <= containerRect.top + 100 && rect.bottom >= containerRect.top + 100) {
                        this.currentPage = parseInt(wrapper.dataset.pageNum);
                        this._updatePageInfo();
                        break;
                    }
                }
            }
            
            _initScrollProgress() {
                // åˆå§‹åŒ–è¿›åº¦æ¡
                this._updateScrollProgress();
            }

            _scrollToPage(pageNum) {
                const pageWrapper = this.viewerContainer.querySelector(`[data-page-num="${pageNum}"]`);
                if (pageWrapper) {
                    pageWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    this.currentPage = pageNum;
                    this._updatePageInfo();
                }
            }

            _scrollToPreviousPage() {
                if (this.currentPage > 1) {
                    this._scrollToPage(this.currentPage - 1);
                }
            }

            _scrollToNextPage() {
                if (this.pdfDoc && this.currentPage < this.pdfDoc.numPages) {
                    this._scrollToPage(this.currentPage + 1);
                }
            }
        }

        // åˆå§‹åŒ–å·¥å…·
        document.addEventListener('DOMContentLoaded', () => {
            new PDFPreviewTool();
        });
    </script>
</body>
</html>
