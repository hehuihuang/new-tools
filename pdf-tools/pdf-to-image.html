<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF è½¬å›¾ç‰‡ - PDF å·¥å…·å¥—ä»¶</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="./shared/styles.css">
    <script src="./shared/utils.js"></script>
    <script src="./shared/components.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../tooles/index.html" class="back-link">â† è¿”å›å·¥å…·ç®±</a>
            <h1>PDF è½¬å›¾ç‰‡</h1>
            <div class="privacy-notice">ğŸ”’ æ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ åˆ°æœåŠ¡å™¨</div>
        </div>

        <div class="card" id="upload-section">
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">ğŸ“„</div>
                <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  PDF æ–‡ä»¶</h3>
            </div>
        </div>

        <div class="card" id="convert-section" style="display: none;">
            <h3>è½¬æ¢è®¾ç½®</h3>
            <div style="margin: 20px 0;">
                <label>è¾“å‡ºæ ¼å¼: 
                    <select id="format" style="padding: 5px;">
                        <option value="png">PNG</option>
                        <option value="jpeg">JPEG</option>
                    </select>
                </label><br><br>
                
                <label>
                    <input type="radio" name="page-selection" value="all" checked> è½¬æ¢æ‰€æœ‰é¡µé¢
                </label><br>
                <label>
                    <input type="radio" name="page-selection" value="range"> æŒ‡å®šé¡µé¢èŒƒå›´
                </label>
                <input type="text" id="page-range" placeholder="ä¾‹å¦‚: 1-3, 5, 7-9" style="margin-left: 10px; padding: 5px; width: 200px;" disabled>
                <br><br>
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn btn-secondary" id="select-all-btn">å…¨é€‰</button>
                    <button class="btn btn-secondary" id="deselect-all-btn">å–æ¶ˆå…¨é€‰</button>
                </div>
                
                <div id="page-thumbnails" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                    <!-- ç¼©ç•¥å›¾å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>
            
            <button class="btn btn-primary" id="convert-btn">è½¬æ¢å¹¶ä¸‹è½½</button>
        </div>
    </div>

    <script>
        class PDFToImageTool {
            constructor() {
                this.uploader = new FileUploader({ multiple: false });
                this.progress = new ProgressIndicator();
                this.pdf = null;
                this.selectedPages = new Set();
                
                this._initElements();
                this._bindEvents();
            }

            _initElements() {
                this.uploadArea = document.getElementById('upload-area');
                this.uploadSection = document.getElementById('upload-section');
                this.convertSection = document.getElementById('convert-section');
                this.formatSelect = document.getElementById('format');
                this.pageRangeInput = document.getElementById('page-range');
                this.thumbnailsContainer = document.getElementById('page-thumbnails');
            }

            _bindEvents() {
                this.uploadArea.addEventListener('click', () => {
                    this.uploader.selectFiles().then(files => {
                        this.loadPDF(files[0]);
                    }).catch(err => {});
                });

                this.uploader.setupDropZone(this.uploadArea, (files) => {
                    this.loadPDF(files[0]);
                });

                // é¡µé¢é€‰æ‹©æ¨¡å¼åˆ‡æ¢
                document.querySelectorAll('input[name="page-selection"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.pageRangeInput.disabled = e.target.value === 'all';
                        if (e.target.value === 'all') {
                            this._selectAllPages();
                        }
                    });
                });

                // é¡µé¢èŒƒå›´è¾“å…¥
                this.pageRangeInput.addEventListener('input', () => {
                    this._updateSelectionFromRange();
                });

                // å…¨é€‰/å–æ¶ˆå…¨é€‰æŒ‰é’®
                document.getElementById('select-all-btn').addEventListener('click', () => {
                    this._selectAllPages();
                });

                document.getElementById('deselect-all-btn').addEventListener('click', () => {
                    this._deselectAllPages();
                });

                document.getElementById('convert-btn').addEventListener('click', () => {
                    this.convertToImages();
                });
            }

            async loadPDF(file) {
                try {
                    this.progress.show('åŠ è½½ PDF...');
                    
                    const arrayBuffer = await this.uploader.readAsArrayBuffer(file);
                    
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    this.pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    // ç”Ÿæˆç¼©ç•¥å›¾
                    await this._generateThumbnails();
                    
                    // é»˜è®¤é€‰ä¸­æ‰€æœ‰é¡µé¢
                    this._selectAllPages();
                    
                    this.uploadSection.style.display = 'none';
                    this.convertSection.style.display = 'block';
                    
                    this.progress.hide();
                    Utils.showSuccess(`PDF åŠ è½½æˆåŠŸï¼å…± ${this.pdf.numPages} é¡µ`);
                    
                } catch (error) {
                    this.progress.hide();
                    Utils.showError('PDF åŠ è½½å¤±è´¥: ' + error.message);
                }
            }

            async _generateThumbnails() {
                this.thumbnailsContainer.innerHTML = '';
                
                for (let i = 1; i <= this.pdf.numPages; i++) {
                    const page = await this.pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 0.5 });
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    await page.render({
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    }).promise;
                    
                    // åˆ›å»ºç¼©ç•¥å›¾å®¹å™¨
                    const thumbDiv = document.createElement('div');
                    thumbDiv.style.cssText = 'border: 2px solid #ddd; padding: 5px; cursor: pointer; text-align: center; border-radius: 4px;';
                    thumbDiv.dataset.pageNum = i;
                    
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL();
                    img.style.cssText = 'width: 100%; display: block;';
                    
                    const label = document.createElement('div');
                    label.textContent = `ç¬¬ ${i} é¡µ`;
                    label.style.cssText = 'margin-top: 5px; font-size: 12px;';
                    
                    thumbDiv.appendChild(img);
                    thumbDiv.appendChild(label);
                    
                    // ç‚¹å‡»åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                    thumbDiv.addEventListener('click', () => {
                        this._togglePageSelection(i, thumbDiv);
                    });
                    
                    this.thumbnailsContainer.appendChild(thumbDiv);
                }
            }

            _togglePageSelection(pageNum, thumbDiv) {
                if (this.selectedPages.has(pageNum)) {
                    this.selectedPages.delete(pageNum);
                    thumbDiv.style.border = '2px solid #ddd';
                    thumbDiv.style.background = '';
                } else {
                    this.selectedPages.add(pageNum);
                    thumbDiv.style.border = '2px solid #4CAF50';
                    thumbDiv.style.background = '#e8f5e9';
                }
            }

            _selectAllPages() {
                this.selectedPages.clear();
                for (let i = 1; i <= this.pdf.numPages; i++) {
                    this.selectedPages.add(i);
                }
                this._updateThumbnailStyles();
            }

            _deselectAllPages() {
                this.selectedPages.clear();
                this._updateThumbnailStyles();
            }

            _updateSelectionFromRange() {
                const rangeStr = this.pageRangeInput.value.trim();
                if (!rangeStr) return;
                
                try {
                    const pages = Utils.parsePageRange(rangeStr, this.pdf.numPages);
                    this.selectedPages = new Set(pages);
                    this._updateThumbnailStyles();
                } catch (error) {
                    Utils.showError('é¡µé¢èŒƒå›´æ ¼å¼é”™è¯¯: ' + error.message);
                }
            }

            _updateThumbnailStyles() {
                const thumbs = this.thumbnailsContainer.querySelectorAll('[data-page-num]');
                thumbs.forEach(thumb => {
                    const pageNum = parseInt(thumb.dataset.pageNum);
                    if (this.selectedPages.has(pageNum)) {
                        thumb.style.border = '2px solid #4CAF50';
                        thumb.style.background = '#e8f5e9';
                    } else {
                        thumb.style.border = '2px solid #ddd';
                        thumb.style.background = '';
                    }
                });
            }

            async convertToImages() {
                try {
                    if (this.selectedPages.size === 0) {
                        Utils.showError('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡µè¿›è¡Œè½¬æ¢');
                        return;
                    }
                    
                    this.progress.show('è½¬æ¢ä¸­...');
                    
                    const format = this.formatSelect.value;
                    const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
                    const images = [];
                    
                    const selectedArray = Array.from(this.selectedPages).sort((a, b) => a - b);
                    const total = selectedArray.length;
                    
                    for (let idx = 0; idx < total; idx++) {
                        const pageNum = selectedArray[idx];
                        this.progress.update(((idx + 1) / total) * 100, `è½¬æ¢ç¬¬ ${pageNum} é¡µ (${idx + 1}/${total})...`);
                        
                        const page = await this.pdf.getPage(pageNum);
                        const viewport = page.getViewport({ scale: 2.0 });
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        await page.render({
                            canvasContext: canvas.getContext('2d'),
                            viewport: viewport
                        }).promise;
                        
                        const blob = await new Promise(resolve => {
                            canvas.toBlob(resolve, mimeType, 0.95);
                        });
                        
                        images.push({ blob, filename: `page-${pageNum}.${format}` });
                    }
                    
                    // å¦‚æœåªæœ‰ä¸€é¡µï¼Œç›´æ¥ä¸‹è½½
                    if (images.length === 1) {
                        Utils.downloadFile(images[0].blob, images[0].filename);
                    } else {
                        // å¤šé¡µæ‰“åŒ…ä¸º ZIP
                        const zip = new JSZip();
                        images.forEach(img => {
                            zip.file(img.filename, img.blob);
                        });
                        
                        const zipBlob = await zip.generateAsync({ type: 'blob' });
                        Utils.downloadFile(zipBlob, 'pdf-images.zip');
                    }
                    
                    this.progress.hide();
                    Utils.showSuccess(`è½¬æ¢å®Œæˆï¼å…±å¯¼å‡º ${images.length} é¡µ`);
                    
                } catch (error) {
                    this.progress.hide();
                    Utils.showError('è½¬æ¢å¤±è´¥: ' + error.message);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new PDFToImageTool();
        });
    </script>
</body>
</html>
