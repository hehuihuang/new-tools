<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF åˆå¹¶ - PDF å·¥å…·å¥—ä»¶</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link rel="stylesheet" href="./shared/styles.css">
    <script src="./shared/utils.js"></script>
    <script src="./shared/components.js"></script>
    
    <style>
        .file-list { list-style: none; margin-top: 20px; }
        .file-item { display: flex; align-items: center; padding: 15px; background: #f9f9f9; border-radius: 4px; margin-bottom: 10px; cursor: move; }
        .file-item:hover { background: #f0f0f0; }
        .file-info { flex: 1; margin-left: 15px; }
        .file-name { font-weight: 500; margin-bottom: 5px; }
        .file-size { font-size: 14px; color: #666; }
        .file-actions { display: flex; gap: 10px; }
        .drag-handle { cursor: move; font-size: 20px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../tooles/index.html" class="back-link">â† è¿”å›å·¥å…·ç®±</a>
            <h1>PDF åˆå¹¶</h1>
            <div class="privacy-notice">ğŸ”’ æ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ åˆ°æœåŠ¡å™¨</div>
        </div>

        <div class="card">
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">ğŸ“„</div>
                <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å¤šä¸ª PDF æ–‡ä»¶</h3>
                <p>æ”¯æŒæœ€å¤§ 50MB çš„ PDF æ–‡ä»¶</p>
            </div>
            
            <ul class="file-list" id="file-list"></ul>
            
            <button class="btn btn-primary" id="merge-btn" style="display: none; margin-top: 20px;">åˆå¹¶ PDF</button>
        </div>
    </div>

    <script>
        class PDFMergeTool {
            constructor() {
                this.uploader = new FileUploader({ multiple: true });
                this.progress = new ProgressIndicator();
                this.files = [];
                
                this._initElements();
                this._bindEvents();
            }

            _initElements() {
                this.uploadArea = document.getElementById('upload-area');
                this.fileList = document.getElementById('file-list');
                this.mergeBtn = document.getElementById('merge-btn');
            }

            _bindEvents() {
                this.uploadArea.addEventListener('click', () => {
                    this.uploader.selectFiles().then(files => {
                        this.addFiles(files);
                    }).catch(err => {});
                });

                this.uploader.setupDropZone(this.uploadArea, (files) => {
                    this.addFiles(files);
                });

                this.mergeBtn.addEventListener('click', () => {
                    this.mergePDFs();
                });
            }

            addFiles(newFiles) {
                this.files.push(...newFiles);
                this._renderFileList();
                this.mergeBtn.style.display = this.files.length > 1 ? 'block' : 'none';
            }

            removeFile(index) {
                this.files.splice(index, 1);
                this._renderFileList();
                this.mergeBtn.style.display = this.files.length > 1 ? 'block' : 'none';
            }

            _renderFileList() {
                this.fileList.innerHTML = '';
                this.files.forEach((file, index) => {
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.innerHTML = `
                        <span class="drag-handle">â˜°</span>
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${Utils.formatFileSize(file.size)}</div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-danger" onclick="tool.removeFile(${index})">åˆ é™¤</button>
                        </div>
                    `;
                    this.fileList.appendChild(li);
                });
            }

            async mergePDFs() {
                try {
                    this.progress.show('åˆå¹¶ PDF æ–‡ä»¶...');
                    
                    const mergedPdf = await PDFLib.PDFDocument.create();
                    
                    for (let i = 0; i < this.files.length; i++) {
                        this.progress.update((i / this.files.length) * 100, `å¤„ç†ç¬¬ ${i + 1}/${this.files.length} ä¸ªæ–‡ä»¶...`);
                        
                        const arrayBuffer = await this.uploader.readAsArrayBuffer(this.files[i]);
                        const pdf = await PDFLib.PDFDocument.load(arrayBuffer);
                        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        copiedPages.forEach(page => mergedPdf.addPage(page));
                    }
                    
                    const mergedPdfBytes = await mergedPdf.save();
                    const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                    
                    Utils.downloadFile(blob, 'merged.pdf');
                    
                    this.progress.hide();
                    Utils.showSuccess('PDF åˆå¹¶æˆåŠŸï¼');
                    
                } catch (error) {
                    this.progress.hide();
                    Utils.showError('PDF åˆå¹¶å¤±è´¥: ' + error.message);
                    console.error(error);
                }
            }
        }

        let tool;
        document.addEventListener('DOMContentLoaded', () => {
            tool = new PDFMergeTool();
        });
    </script>
</body>
</html>
