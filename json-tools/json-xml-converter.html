<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON/XML 转换 - JSON 工具套件</title>
    <link rel="stylesheet" href="./shared/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../tooles/index.html" class="back-link">← 返回工具箱</a>
            <h1>JSON ↔ XML 转换</h1>
            <p>在 JSON 和 XML 格式之间互相转换</p>
            <div class="privacy-notice">🔒 所有处理均在本地完成，不上传到服务器</div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="json-to-xml">JSON → XML</button>
            <button class="tab" data-tab="xml-to-json">XML → JSON</button>
        </div>

        <div class="tab-content active" id="json-to-xml">
            <div class="card">
                <div class="editor-container">
                    <label class="editor-label">输入 JSON 数据</label>
                    <textarea id="json-input" class="editor" placeholder="在此输入或粘贴 JSON 数据..."></textarea>
                </div>

                <div class="input-group">
                    <label for="root-name">根元素名称</label>
                    <input type="text" id="root-name" value="root" placeholder="root">
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" id="json-to-xml-btn">转换为 XML</button>
                    <button class="btn btn-secondary" id="upload-json-btn">上传 JSON 文件</button>
                </div>
            </div>

            <div class="card" id="xml-output-section" style="display: none;">
                <div class="editor-container">
                    <label class="editor-label">XML 输出</label>
                    <textarea id="xml-output" class="editor" readonly></textarea>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" id="copy-xml-btn">复制</button>
                    <button class="btn btn-secondary" id="download-xml-btn">下载 XML</button>
                </div>
            </div>
        </div>

        <div class="tab-content" id="xml-to-json">
            <div class="card">
                <div class="editor-container">
                    <label class="editor-label">输入 XML 数据</label>
                    <textarea id="xml-input" class="editor" placeholder="在此输入或粘贴 XML 数据..."></textarea>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" id="xml-to-json-btn">转换为 JSON</button>
                    <button class="btn btn-secondary" id="upload-xml-btn">上传 XML 文件</button>
                </div>
            </div>

            <div class="card" id="json-output-section" style="display: none;">
                <div class="editor-container">
                    <label class="editor-label">JSON 输出</label>
                    <textarea id="json-output" class="editor" readonly></textarea>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" id="copy-json-btn">复制</button>
                    <button class="btn btn-secondary" id="download-json-btn">下载 JSON</button>
                </div>
            </div>
        </div>
    </div>

    <script src="./shared/utils.js"></script>
    <script src="./shared/components.js"></script>
    <script>
        class JSONXMLConverterTool {
            constructor() {
                this.fileHandler = new FileHandler();
                this._initElements();
                this._bindEvents();
            }

            _initElements() {
                this.jsonInput = document.getElementById('json-input');
                this.xmlInput = document.getElementById('xml-input');
                this.xmlOutput = document.getElementById('xml-output');
                this.jsonOutput = document.getElementById('json-output');
                this.rootNameInput = document.getElementById('root-name');
                this.xmlOutputSection = document.getElementById('xml-output-section');
                this.jsonOutputSection = document.getElementById('json-output-section');
            }

            _bindEvents() {
                // 选项卡切换
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // JSON 转 XML
                document.getElementById('json-to-xml-btn').addEventListener('click', () => {
                    this.jsonToXML();
                });

                // XML 转 JSON
                document.getElementById('xml-to-json-btn').addEventListener('click', () => {
                    this.xmlToJSON();
                });

                // 上传按钮
                document.getElementById('upload-json-btn').addEventListener('click', async () => {
                    await this.uploadFile(this.jsonInput, ['.json', '.txt']);
                });

                document.getElementById('upload-xml-btn').addEventListener('click', async () => {
                    await this.uploadFile(this.xmlInput, ['.xml', '.txt']);
                });

                // 复制按钮
                document.getElementById('copy-xml-btn').addEventListener('click', async () => {
                    await this.fileHandler.copyToClipboard(this.xmlOutput.value);
                });

                document.getElementById('copy-json-btn').addEventListener('click', async () => {
                    await this.fileHandler.copyToClipboard(this.jsonOutput.value);
                });

                // 下载按钮
                document.getElementById('download-xml-btn').addEventListener('click', () => {
                    this.downloadFile(this.xmlOutput.value, 'converted.xml');
                });

                document.getElementById('download-json-btn').addEventListener('click', () => {
                    this.downloadFile(this.jsonOutput.value, 'converted.json');
                });
            }

            switchTab(tabId) {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(tabId).classList.add('active');
            }

            jsonToXML() {
                const input = this.jsonInput.value.trim();
                
                if (!input) {
                    Utils.showError('请输入 JSON 数据');
                    return;
                }

                try {
                    Utils.showLoading('转换中...');
                    const obj = JSON.parse(input);
                    const rootName = this.rootNameInput.value.trim() || 'root';
                    const xml = Utils.jsonToXML(obj, rootName);
                    this.xmlOutput.value = xml;
                    this.xmlOutputSection.style.display = 'block';
                    this.jsonInput.classList.remove('error');
                    Utils.hideLoading();
                    Utils.showSuccess('转换成功');
                } catch (error) {
                    Utils.hideLoading();
                    this.jsonInput.classList.add('error');
                    Utils.showError('转换失败: ' + error.message);
                    this.xmlOutputSection.style.display = 'none';
                }
            }

            xmlToJSON() {
                const input = this.xmlInput.value.trim();
                
                if (!input) {
                    Utils.showError('请输入 XML 数据');
                    return;
                }

                try {
                    Utils.showLoading('转换中...');
                    const obj = Utils.xmlToJSON(input);
                    const json = JSON.stringify(obj, null, 2);
                    this.jsonOutput.value = json;
                    this.jsonOutputSection.style.display = 'block';
                    this.xmlInput.classList.remove('error');
                    Utils.hideLoading();
                    Utils.showSuccess('转换成功');
                } catch (error) {
                    Utils.hideLoading();
                    this.xmlInput.classList.add('error');
                    Utils.showError('转换失败: ' + error.message);
                    this.jsonOutputSection.style.display = 'none';
                }
            }

            async uploadFile(editor, acceptTypes) {
                try {
                    const file = await this.fileHandler.uploadFile(acceptTypes);
                    const content = await this.fileHandler.readAsText(file);
                    editor.value = content;
                    Utils.showSuccess('文件上传成功');
                } catch (error) {
                    if (error.message !== '未选择文件') {
                        Utils.showError('文件上传失败: ' + error.message);
                    }
                }
            }

            downloadFile(content, filename) {
                if (!content) {
                    Utils.showError('没有可下载的内容');
                    return;
                }
                this.fileHandler.downloadFile(content, Utils.generateFilename(filename.split('.')[0], filename.split('.')[1]));
                Utils.showSuccess('文件下载成功');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new JSONXMLConverterTool();
        });
    </script>
</body>
</html>
