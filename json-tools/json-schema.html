<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Schema - JSON å·¥å…·å¥—ä»¶</title>
    <link rel="stylesheet" href="./shared/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/ajv@8/dist/2020.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../tooles/index.html" class="back-link">â† è¿”å›å·¥å…·ç®±</a>
            <h1>JSON Schema ç”Ÿæˆä¸æ ¡éªŒ</h1>
            <p>æ ¹æ® JSON è‡ªåŠ¨ç”Ÿæˆ Schemaï¼Œæˆ–ä½¿ç”¨ Schema éªŒè¯ JSON æ•°æ®</p>
            <div class="privacy-notice">ğŸ”’ æ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ åˆ°æœåŠ¡å™¨</div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="generate-schema">ç”Ÿæˆ Schema</button>
            <button class="tab" data-tab="validate-schema">éªŒè¯ Schema</button>
        </div>

        <div class="tab-content active" id="generate-schema">
            <div class="card">
                <div class="editor-container">
                    <label class="editor-label">è¾“å…¥ JSON æ•°æ®</label>
                    <textarea id="json-for-schema" class="editor" placeholder="åœ¨æ­¤è¾“å…¥ JSON æ•°æ®ï¼Œå°†è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ Schema..."></textarea>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" id="generate-btn">ç”Ÿæˆ Schema</button>
                    <button class="btn btn-secondary" id="upload-json-schema-btn">ä¸Šä¼  JSON æ–‡ä»¶</button>
                </div>
            </div>

            <div class="card" id="schema-output-section" style="display: none;">
                <div class="editor-container">
                    <label class="editor-label">ç”Ÿæˆçš„ Schema</label>
                    <textarea id="schema-output" class="editor" readonly></textarea>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" id="copy-schema-btn">å¤åˆ¶</button>
                    <button class="btn btn-secondary" id="download-schema-btn">ä¸‹è½½ Schema</button>
                </div>
            </div>
        </div>

        <div class="tab-content" id="validate-schema">
            <div class="split-view">
                <div class="card">
                    <div class="editor-container">
                        <label class="editor-label">JSON Schema</label>
                        <textarea id="schema-input" class="editor" placeholder="åœ¨æ­¤è¾“å…¥ JSON Schema..."></textarea>
                    </div>
                    <button class="btn btn-secondary" id="upload-schema-btn" style="margin-top: 10px;">ä¸Šä¼  Schema</button>
                </div>

                <div class="card">
                    <div class="editor-container">
                        <label class="editor-label">å¾…éªŒè¯çš„ JSON æ•°æ®</label>
                        <textarea id="json-to-validate" class="editor" placeholder="åœ¨æ­¤è¾“å…¥å¾…éªŒè¯çš„ JSON æ•°æ®..."></textarea>
                    </div>
                    <button class="btn btn-secondary" id="upload-json-validate-btn" style="margin-top: 10px;">ä¸Šä¼  JSON</button>
                </div>
            </div>

            <div class="card">
                <button class="btn btn-primary" id="validate-btn">éªŒè¯</button>
            </div>

            <div class="card" id="validation-result-section" style="display: none;">
                <h3 id="validation-title">éªŒè¯ç»“æœ</h3>
                <div id="validation-content"></div>
            </div>
        </div>
    </div>

    <script src="./shared/utils.js"></script>
    <script src="./shared/components.js"></script>
    <script>
        class JSONSchemaTool {
            constructor() {
                this.fileHandler = new FileHandler();
                this._initElements();
                this._bindEvents();
                
                // åˆå§‹åŒ– Ajv
                if (typeof window.ajv8 !== 'undefined') {
                    this.ajv = new window.ajv8.default();
                }
            }

            _initElements() {
                this.jsonForSchema = document.getElementById('json-for-schema');
                this.schemaOutput = document.getElementById('schema-output');
                this.schemaInput = document.getElementById('schema-input');
                this.jsonToValidate = document.getElementById('json-to-validate');
                this.schemaOutputSection = document.getElementById('schema-output-section');
                this.validationResultSection = document.getElementById('validation-result-section');
                this.validationTitle = document.getElementById('validation-title');
                this.validationContent = document.getElementById('validation-content');
            }

            _bindEvents() {
                // é€‰é¡¹å¡åˆ‡æ¢
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // ç”Ÿæˆ Schema
                document.getElementById('generate-btn').addEventListener('click', () => {
                    this.generateSchema();
                });

                // éªŒè¯
                document.getElementById('validate-btn').addEventListener('click', () => {
                    this.validateWithSchema();
                });

                // ä¸Šä¼ æŒ‰é’®
                document.getElementById('upload-json-schema-btn').addEventListener('click', async () => {
                    await this.uploadFile(this.jsonForSchema);
                });

                document.getElementById('upload-schema-btn').addEventListener('click', async () => {
                    await this.uploadFile(this.schemaInput);
                });

                document.getElementById('upload-json-validate-btn').addEventListener('click', async () => {
                    await this.uploadFile(this.jsonToValidate);
                });

                // å¤åˆ¶å’Œä¸‹è½½
                document.getElementById('copy-schema-btn').addEventListener('click', async () => {
                    await this.fileHandler.copyToClipboard(this.schemaOutput.value);
                });

                document.getElementById('download-schema-btn').addEventListener('click', () => {
                    this.downloadFile(this.schemaOutput.value, 'schema.json');
                });
            }

            switchTab(tabId) {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(tabId).classList.add('active');
            }

            generateSchema() {
                const input = this.jsonForSchema.value.trim();
                
                if (!input) {
                    Utils.showError('è¯·è¾“å…¥ JSON æ•°æ®');
                    return;
                }

                try {
                    Utils.showLoading('ç”Ÿæˆä¸­...');
                    const obj = JSON.parse(input);
                    const schema = Utils.generateSchema(obj);
                    this.schemaOutput.value = JSON.stringify(schema, null, 2);
                    this.schemaOutputSection.style.display = 'block';
                    this.jsonForSchema.classList.remove('error');
                    Utils.hideLoading();
                    Utils.showSuccess('Schema ç”ŸæˆæˆåŠŸ');
                } catch (error) {
                    Utils.hideLoading();
                    this.jsonForSchema.classList.add('error');
                    Utils.showError('ç”Ÿæˆå¤±è´¥: ' + error.message);
                    this.schemaOutputSection.style.display = 'none';
                }
            }

            validateWithSchema() {
                const schemaStr = this.schemaInput.value.trim();
                const jsonStr = this.jsonToValidate.value.trim();
                
                if (!schemaStr || !jsonStr) {
                    Utils.showError('è¯·è¾“å…¥ Schema å’Œ JSON æ•°æ®');
                    return;
                }

                if (!this.ajv) {
                    Utils.showError('Schema éªŒè¯åº“æœªåŠ è½½');
                    return;
                }

                try {
                    Utils.showLoading('éªŒè¯ä¸­...');
                    
                    const schema = JSON.parse(schemaStr);
                    const data = JSON.parse(jsonStr);
                    
                    const validate = this.ajv.compile(schema);
                    const valid = validate(data);
                    
                    if (valid) {
                        this.showValidationSuccess();
                    } else {
                        this.showValidationErrors(validate.errors);
                    }
                    
                    this.schemaInput.classList.remove('error');
                    this.jsonToValidate.classList.remove('error');
                    this.validationResultSection.style.display = 'block';
                    Utils.hideLoading();
                } catch (error) {
                    Utils.hideLoading();
                    Utils.showError('éªŒè¯å¤±è´¥: ' + error.message);
                    this.validationResultSection.style.display = 'none';
                }
            }

            showValidationSuccess() {
                this.validationTitle.textContent = 'âœ“ éªŒè¯æˆåŠŸ';
                this.validationTitle.style.color = '#4CAF50';
                this.validationContent.innerHTML = `
                    <div style="background-color: #E8F5E9; padding: 15px; border-radius: 4px; border-left: 4px solid #4CAF50;">
                        <p style="margin: 0;">JSON æ•°æ®ç¬¦åˆ Schema å®šä¹‰</p>
                    </div>
                `;
            }

            showValidationErrors(errors) {
                this.validationTitle.textContent = 'âœ— éªŒè¯å¤±è´¥';
                this.validationTitle.style.color = '#F44336';
                
                const errorList = errors.map(err => `
                    <div style="background-color: #FFEBEE; padding: 10px; border-radius: 4px; margin-bottom: 10px; border-left: 4px solid #F44336;">
                        <p style="margin: 0 0 5px 0; font-weight: 500;">è·¯å¾„: ${err.instancePath || '/'}</p>
                        <p style="margin: 0; color: #757575;">${err.message}</p>
                    </div>
                `).join('');
                
                this.validationContent.innerHTML = errorList;
            }

            async uploadFile(editor) {
                try {
                    const file = await this.fileHandler.uploadFile(['.json', '.txt']);
                    const content = await this.fileHandler.readAsText(file);
                    editor.value = content;
                    Utils.showSuccess('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                } catch (error) {
                    if (error.message !== 'æœªé€‰æ‹©æ–‡ä»¶') {
                        Utils.showError('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message);
                    }
                }
            }

            downloadFile(content, filename) {
                if (!content) {
                    Utils.showError('æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹');
                    return;
                }
                this.fileHandler.downloadFile(content, Utils.generateFilename(filename.split('.')[0], filename.split('.')[1]));
                Utils.showSuccess('æ–‡ä»¶ä¸‹è½½æˆåŠŸ');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new JSONSchemaTool();
        });
    </script>
</body>
</html>
