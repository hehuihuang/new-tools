<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown è¡¨æ ¼/CSV è½¬æ¢ - ä»£ç å·¥å…·å¥—ä»¶</title>
    <link rel="stylesheet" href="./shared/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../tooles/index.html" class="back-link">â† è¿”å›å·¥å…·ç®±</a>
            <h1>Markdown è¡¨æ ¼ / CSV è½¬æ¢</h1>
            <p>å°† CSV è½¬æˆ Markdown è¡¨æ ¼ï¼Œæˆ–åå‘ç”Ÿæˆ CSVï¼Œæé«˜æ–‡æ¡£å¤„ç†æ•ˆç‡</p>
            <div class="privacy-notice">ğŸ”’ æ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ åˆ°æœåŠ¡å™¨</div>
        </div>

        <!-- æ ‡ç­¾é¡µ -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" data-tab="csv2md">CSV â†’ Markdown</button>
                <button class="tab" data-tab="md2csv">Markdown â†’ CSV</button>
                <button class="tab" data-tab="editor">å¯è§†åŒ–ç¼–è¾‘å™¨</button>
            </div>

            <!-- CSV è½¬ Markdown -->
            <div id="csv2md" class="tab-content active">
                <div class="editor-container">
                    <label class="editor-label">è¾“å…¥ CSV æ•°æ®</label>
                    <textarea id="csv-input" class="editor" placeholder="å§“å,å¹´é¾„,åŸå¸‚&#10;å¼ ä¸‰,25,åŒ—äº¬&#10;æå››,30,ä¸Šæµ·&#10;ç‹äº”,28,å¹¿å·"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="csv2md-btn">è½¬æ¢ä¸º Markdown</button>
                    <button class="btn btn-danger" id="clear-csv-btn">æ¸…ç©º</button>
                </div>
            </div>

            <!-- Markdown è½¬ CSV -->
            <div id="md2csv" class="tab-content">
                <div class="editor-container">
                    <label class="editor-label">è¾“å…¥ Markdown è¡¨æ ¼</label>
                    <textarea id="md-input" class="editor" placeholder="| å§“å | å¹´é¾„ | åŸå¸‚ |&#10;| --- | --- | --- |&#10;| å¼ ä¸‰ | 25 | åŒ—äº¬ |&#10;| æå›› | 30 | ä¸Šæµ· |"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" id="md2csv-btn">è½¬æ¢ä¸º CSV</button>
                    <button class="btn btn-danger" id="clear-md-btn">æ¸…ç©º</button>
                </div>
            </div>

            <!-- å¯è§†åŒ–ç¼–è¾‘å™¨ -->
            <div id="editor" class="tab-content">
                <div id="table-editor"></div>
                <div class="btn-group" style="margin-top: 15px;">
                    <button class="btn btn-primary" id="generate-md-btn">ç”Ÿæˆ Markdown</button>
                    <button class="btn btn-primary" id="generate-csv-btn">ç”Ÿæˆ CSV</button>
                </div>
            </div>
        </div>

        <!-- è¾“å‡ºåŒºåŸŸ -->
        <div class="card" id="output-section" style="display: none;">
            <h3 class="card-title">è¾“å‡ºç»“æœ</h3>
            <div class="editor-container">
                <textarea id="output-editor" class="editor" readonly></textarea>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" id="copy-btn">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
                <button class="btn btn-secondary" id="download-btn">ä¸‹è½½æ–‡ä»¶</button>
            </div>
        </div>

        <!-- Markdown é¢„è§ˆ -->
        <div class="card" id="preview-section" style="display: none;">
            <h3 class="card-title">è¡¨æ ¼é¢„è§ˆ</h3>
            <div id="table-preview" class="preview"></div>
        </div>
    </div>

    <script src="./shared/utils.js"></script>
    <script src="./shared/components.js"></script>
    <script>
        class TableConverterTool {
            constructor() {
                this.outputEditor = document.getElementById('output-editor');
                this.outputSection = document.getElementById('output-section');
                this.previewSection = document.getElementById('preview-section');
                this.tablePreview = document.getElementById('table-preview');
                this.fileHandler = new FileHandler();
                this.editableTable = null;
                this.currentOutputType = 'md';
                
                this._bindEvents();
                this._initEditor();
            }

            _bindEvents() {
                // æ ‡ç­¾é¡µåˆ‡æ¢
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        e.target.classList.add('active');
                        document.getElementById(e.target.dataset.tab).classList.add('active');
                    });
                });

                // CSV è½¬ Markdown
                document.getElementById('csv2md-btn').addEventListener('click', () => this.csvToMarkdown());
                document.getElementById('clear-csv-btn').addEventListener('click', () => {
                    document.getElementById('csv-input').value = '';
                    this.hideOutput();
                });

                // Markdown è½¬ CSV
                document.getElementById('md2csv-btn').addEventListener('click', () => this.markdownToCSV());
                document.getElementById('clear-md-btn').addEventListener('click', () => {
                    document.getElementById('md-input').value = '';
                    this.hideOutput();
                });

                // å¯è§†åŒ–ç¼–è¾‘å™¨
                document.getElementById('generate-md-btn').addEventListener('click', () => this.generateFromEditor('md'));
                document.getElementById('generate-csv-btn').addEventListener('click', () => this.generateFromEditor('csv'));

                // å¤åˆ¶å’Œä¸‹è½½
                document.getElementById('copy-btn').addEventListener('click', () => this.copy());
                document.getElementById('download-btn').addEventListener('click', () => this.download());
            }

            _initEditor() {
                this.editableTable = new EditableTable(document.getElementById('table-editor'), {
                    rows: 4,
                    cols: 3
                });
            }

            csvToMarkdown() {
                const csv = document.getElementById('csv-input').value.trim();
                if (!csv) {
                    CodeUtils.showWarning('è¯·è¾“å…¥ CSV æ•°æ®');
                    return;
                }

                try {
                    const markdown = CodeUtils.csvToMarkdownTable(csv);
                    this.showOutput(markdown, 'md');
                    this.showPreview(markdown);
                    CodeUtils.showSuccess('è½¬æ¢æˆåŠŸ');
                } catch (error) {
                    CodeUtils.showError('è½¬æ¢å¤±è´¥: ' + error.message);
                }
            }

            markdownToCSV() {
                const markdown = document.getElementById('md-input').value.trim();
                if (!markdown) {
                    CodeUtils.showWarning('è¯·è¾“å…¥ Markdown è¡¨æ ¼');
                    return;
                }

                try {
                    const csv = CodeUtils.markdownTableToCSV(markdown);
                    this.showOutput(csv, 'csv');
                    this.previewSection.style.display = 'none';
                    CodeUtils.showSuccess('è½¬æ¢æˆåŠŸ');
                } catch (error) {
                    CodeUtils.showError('è½¬æ¢å¤±è´¥: ' + error.message);
                }
            }

            generateFromEditor(type) {
                const data = this.editableTable.getData();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
                const hasData = data.some(row => row.some(cell => cell.trim()));
                if (!hasData) {
                    CodeUtils.showWarning('è¯·åœ¨è¡¨æ ¼ä¸­è¾“å…¥æ•°æ®');
                    return;
                }

                if (type === 'md') {
                    const markdown = this.editableTable.toMarkdown();
                    this.showOutput(markdown, 'md');
                    this.showPreview(markdown);
                } else {
                    const csv = this.editableTable.toCSV();
                    this.showOutput(csv, 'csv');
                    this.previewSection.style.display = 'none';
                }
                
                CodeUtils.showSuccess('ç”ŸæˆæˆåŠŸ');
            }

            showOutput(content, type) {
                this.outputEditor.value = content;
                this.outputSection.style.display = 'block';
                this.currentOutputType = type;
            }

            hideOutput() {
                this.outputSection.style.display = 'none';
                this.previewSection.style.display = 'none';
            }

            showPreview(markdown) {
                // å°† Markdown è¡¨æ ¼è½¬æ¢ä¸º HTML è¡¨æ ¼
                const rows = markdown.trim().split('\n');
                let html = '<table class="data-table">';
                
                rows.forEach((row, index) => {
                    // è·³è¿‡åˆ†éš”è¡Œ
                    if (/^\|[\s-:|]+\|$/.test(row)) return;
                    
                    const cells = row.replace(/^\||\|$/g, '').split('|').map(c => c.trim());
                    const tag = index === 0 ? 'th' : 'td';
                    
                    html += '<tr>';
                    cells.forEach(cell => {
                        html += `<${tag}>${cell}</${tag}>`;
                    });
                    html += '</tr>';
                });
                
                html += '</table>';
                this.tablePreview.innerHTML = html;
                this.previewSection.style.display = 'block';
            }

            async copy() {
                const output = this.outputEditor.value;
                if (!output) {
                    CodeUtils.showWarning('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
                    return;
                }
                await this.fileHandler.copyToClipboard(output);
            }

            download() {
                const output = this.outputEditor.value;
                if (!output) {
                    CodeUtils.showWarning('æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹');
                    return;
                }
                
                const ext = this.currentOutputType === 'md' ? 'md' : 'csv';
                const mimeType = this.currentOutputType === 'md' ? 'text/markdown' : 'text/csv';
                const filename = CodeUtils.generateFilename('table', ext);
                this.fileHandler.downloadFile(output, filename, mimeType);
                CodeUtils.showSuccess('æ–‡ä»¶ä¸‹è½½æˆåŠŸ');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new TableConverterTool();
        });
    </script>
</body>
</html>
