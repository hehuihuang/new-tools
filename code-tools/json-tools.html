<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON æ ¼å¼åŒ–/å‹ç¼©/æ ¡éªŒ - ä»£ç å·¥å…·å¥—ä»¶</title>
    <link rel="stylesheet" href="./shared/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../tooles/index.html" class="back-link">â† è¿”å›å·¥å…·ç®±</a>
            <h1>JSON æ ¼å¼åŒ– / å‹ç¼© / æ ¡éªŒ</h1>
            <p>æ”¯æŒ JSON è‡ªåŠ¨ç¾åŒ–ã€å‹ç¼©ã€æ ¡éªŒç»“æ„æ˜¯å¦åˆæ³•</p>
            <div class="privacy-notice">ğŸ”’ æ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ åˆ°æœåŠ¡å™¨</div>
        </div>

        <div class="card">
            <div class="editor-container">
                <label class="editor-label">è¾“å…¥ JSON æ•°æ®</label>
                <textarea id="input-editor" class="editor" placeholder="åœ¨æ­¤è¾“å…¥æˆ–ç²˜è´´ JSON æ•°æ®..."></textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" id="format-btn">æ ¼å¼åŒ–</button>
                <button class="btn btn-primary" id="compress-btn">å‹ç¼©</button>
                <button class="btn btn-success" id="validate-btn">æ ¡éªŒ</button>
                <button class="btn btn-secondary" id="upload-btn">ä¸Šä¼ æ–‡ä»¶</button>
                <button class="btn btn-danger" id="clear-btn">æ¸…ç©º</button>
            </div>
        </div>

        <!-- æ ¡éªŒç»“æœ -->
        <div class="card" id="validation-result" style="display: none;">
            <h3 class="card-title">æ ¡éªŒç»“æœ</h3>
            <div id="validation-content"></div>
        </div>

        <!-- è¾“å‡ºåŒºåŸŸ -->
        <div class="card" id="output-section" style="display: none;">
            <div class="editor-container">
                <label class="editor-label">è¾“å‡ºç»“æœ</label>
                <textarea id="output-editor" class="editor" readonly></textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" id="copy-btn">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
                <button class="btn btn-secondary" id="download-btn">ä¸‹è½½æ–‡ä»¶</button>
            </div>
        </div>
    </div>

    <script src="./shared/utils.js"></script>
    <script src="./shared/components.js"></script>
    <script>
        class JSONTool {
            constructor() {
                this.inputEditor = document.getElementById('input-editor');
                this.outputEditor = document.getElementById('output-editor');
                this.outputSection = document.getElementById('output-section');
                this.validationResult = document.getElementById('validation-result');
                this.validationContent = document.getElementById('validation-content');
                this.fileHandler = new FileHandler();
                
                this._bindEvents();
            }

            _bindEvents() {
                document.getElementById('format-btn').addEventListener('click', () => this.format());
                document.getElementById('compress-btn').addEventListener('click', () => this.compress());
                document.getElementById('validate-btn').addEventListener('click', () => this.validate());
                document.getElementById('upload-btn').addEventListener('click', () => this.upload());
                document.getElementById('clear-btn').addEventListener('click', () => this.clear());
                document.getElementById('copy-btn').addEventListener('click', () => this.copy());
                document.getElementById('download-btn').addEventListener('click', () => this.download());

                // å®æ—¶æ ¡éªŒ
                this.inputEditor.addEventListener('input', () => {
                    this.inputEditor.classList.remove('error');
                    this.validationResult.style.display = 'none';
                });
            }

            format() {
                const input = this.inputEditor.value.trim();
                if (!input) {
                    CodeUtils.showWarning('è¯·è¾“å…¥ JSON æ•°æ®');
                    return;
                }

                try {
                    const formatted = CodeUtils.formatJSON(input, 2);
                    this.outputEditor.value = formatted;
                    this.outputSection.style.display = 'block';
                    this.inputEditor.classList.remove('error');
                    CodeUtils.showSuccess('JSON æ ¼å¼åŒ–æˆåŠŸ');
                } catch (error) {
                    this.inputEditor.classList.add('error');
                    this._showValidationError(error.message);
                }
            }

            compress() {
                const input = this.inputEditor.value.trim();
                if (!input) {
                    CodeUtils.showWarning('è¯·è¾“å…¥ JSON æ•°æ®');
                    return;
                }

                try {
                    const compressed = CodeUtils.compressJSON(input);
                    this.outputEditor.value = compressed;
                    this.outputSection.style.display = 'block';
                    this.inputEditor.classList.remove('error');
                    
                    const ratio = ((input.length - compressed.length) / input.length * 100).toFixed(1);
                    CodeUtils.showSuccess(`JSON å‹ç¼©æˆåŠŸï¼å‡å°‘äº† ${ratio}% çš„å¤§å°`);
                } catch (error) {
                    this.inputEditor.classList.add('error');
                    this._showValidationError(error.message);
                }
            }

            validate() {
                const input = this.inputEditor.value.trim();
                if (!input) {
                    CodeUtils.showWarning('è¯·è¾“å…¥ JSON æ•°æ®');
                    return;
                }

                const result = CodeUtils.validateJSON(input);
                this.validationResult.style.display = 'block';

                if (result.valid) {
                    this.inputEditor.classList.remove('error');
                    this.validationContent.innerHTML = `
                        <div style="color: #27ae60; margin-bottom: 15px;">
                            <strong>âœ“ JSON æ ¼å¼æ­£ç¡®</strong>
                        </div>
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-value">${result.stats.keys}</div>
                                <div class="stat-label">é”®æ•°é‡</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${result.stats.depth}</div>
                                <div class="stat-label">åµŒå¥—æ·±åº¦</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${CodeUtils.formatFileSize(result.stats.size)}</div>
                                <div class="stat-label">æ•°æ®å¤§å°</div>
                            </div>
                        </div>
                    `;
                } else {
                    this._showValidationError(result.error.message, result.error.line, result.error.column);
                }
            }

            _showValidationError(message, line, column) {
                this.inputEditor.classList.add('error');
                this.validationResult.style.display = 'block';
                
                let errorInfo = `<div style="color: #e74c3c;"><strong>âœ— JSON æ ¼å¼é”™è¯¯</strong></div>`;
                errorInfo += `<p style="margin-top: 10px;">${message}</p>`;
                
                if (line && column) {
                    errorInfo += `<p style="color: #666;">ä½ç½®: ç¬¬ ${line} è¡Œ, ç¬¬ ${column} åˆ—</p>`;
                }
                
                this.validationContent.innerHTML = errorInfo;
                CodeUtils.showError('JSON æ ¼å¼é”™è¯¯');
            }

            async upload() {
                try {
                    const file = await this.fileHandler.uploadFile(['.json', '.txt']);
                    const content = await this.fileHandler.readAsText(file);
                    this.inputEditor.value = content;
                    CodeUtils.showSuccess('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                } catch (error) {
                    if (error.message !== 'æœªé€‰æ‹©æ–‡ä»¶') {
                        CodeUtils.showError(error.message);
                    }
                }
            }

            clear() {
                this.inputEditor.value = '';
                this.outputEditor.value = '';
                this.outputSection.style.display = 'none';
                this.validationResult.style.display = 'none';
                this.inputEditor.classList.remove('error');
            }

            async copy() {
                const output = this.outputEditor.value;
                if (!output) {
                    CodeUtils.showWarning('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
                    return;
                }
                await this.fileHandler.copyToClipboard(output);
            }

            download() {
                const output = this.outputEditor.value;
                if (!output) {
                    CodeUtils.showWarning('æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹');
                    return;
                }
                const filename = CodeUtils.generateFilename('json', 'json');
                this.fileHandler.downloadFile(output, filename, 'application/json');
                CodeUtils.showSuccess('æ–‡ä»¶ä¸‹è½½æˆåŠŸ');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new JSONTool();
        });
    </script>
</body>
</html>
