<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¹´ç»ˆå¥–ä¸ªç¨è®¡ç®—å™¨ - è´¢ç¨å·¥å…·</title>
  <link rel="stylesheet" href="shared/styles.css">
</head>
<body>
  <div class="container">
    <div id="header"></div>

    <div class="card">
      <h3 class="card-title">è¾“å…¥ä¿¡æ¯</h3>
      
      <div id="bonus-input"></div>
      <div id="annual-income-input"></div>
      
      <div class="options-group">
        <div class="option-item">
          <input type="radio" id="method-separate" name="method" value="separate" checked>
          <label for="method-separate">å•ç‹¬è®¡ç¨</label>
        </div>
        <div class="option-item">
          <input type="radio" id="method-combined" name="method" value="combined">
          <label for="method-combined">å¹¶å…¥ç»¼åˆæ‰€å¾—</label>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" onclick="calculate()">è®¡ç®—</button>
        <button class="btn btn-secondary" onclick="clearForm()">æ¸…ç©º</button>
      </div>
    </div>

    <div id="result-container" style="display: none;">
      <div id="result-card"></div>
      <div id="comparison-card"></div>
      <div id="details-card"></div>
    </div>
  </div>

  <script src="shared/components.js"></script>
  <script src="shared/utils.js"></script>
  <script src="shared/calculators.js"></script>
  <script>
    // åˆå§‹åŒ–é¡µé¢
    document.getElementById('header').innerHTML = createFinanceHeader(
      'å¹´ç»ˆå¥–ä¸ªç¨è®¡ç®—å™¨',
      'è®¡ç®—å¹´ç»ˆå¥–çš„ä¸ªäººæ‰€å¾—ç¨ï¼Œå¯¹æ¯”å•ç‹¬è®¡ç¨å’Œå¹¶å…¥ç»¼åˆæ‰€å¾—ä¸¤ç§æ–¹å¼'
    );

    document.getElementById('bonus-input').innerHTML = createInputGroup({
      label: 'å¹´ç»ˆå¥–é‡‘é¢',
      id: 'bonus',
      type: 'number',
      placeholder: 'è¯·è¾“å…¥å¹´ç»ˆå¥–é‡‘é¢',
      required: true,
      min: 0,
      step: '0.01',
      unit: 'å…ƒ'
    });

    document.getElementById('annual-income-input').innerHTML = createInputGroup({
      label: 'å¹´åº¦ç»¼åˆæ‰€å¾—',
      id: 'annualIncome',
      type: 'number',
      placeholder: 'å¹¶å…¥æ–¹å¼éœ€è¦å¡«å†™',
      min: 0,
      step: '0.01',
      unit: 'å…ƒ',
      hint: 'ä»…åœ¨é€‰æ‹©"å¹¶å…¥ç»¼åˆæ‰€å¾—"æ—¶éœ€è¦å¡«å†™'
    });

    // åŠ è½½ä¸Šæ¬¡è¾“å…¥
    const lastInput = loadLastInput('bonus-tax');
    if (lastInput) {
      document.getElementById('bonus').value = lastInput.bonus || '';
      document.getElementById('annualIncome').value = lastInput.annualIncome || '';
      if (lastInput.method) {
        document.getElementById(`method-${lastInput.method}`).checked = true;
      }
    }

    // è®¡ç®—å‡½æ•°
    function calculate() {
      clearAllInputErrors();
      
      const bonus = document.getElementById('bonus').value;
      const annualIncome = document.getElementById('annualIncome').value;
      const method = document.querySelector('input[name="method"]:checked').value;

      // éªŒè¯è¾“å…¥
      const bonusValidation = validateNumber(bonus, 0);
      if (!bonusValidation.valid) {
        showInputError('bonus', bonusValidation.error);
        return;
      }

      if (method === 'combined') {
        const incomeValidation = validateNumber(annualIncome, 0);
        if (!incomeValidation.valid) {
          showInputError('annualIncome', incomeValidation.error);
          return;
        }
      }

      // ä¿å­˜è¾“å…¥
      saveLastInput('bonus-tax', {
        bonus: bonusValidation.value,
        annualIncome: method === 'combined' ? Number(annualIncome) : 0,
        method
      });

      // è®¡ç®—
      const result = calculateBonusTax(
        bonusValidation.value,
        method,
        method === 'combined' ? Number(annualIncome) : 0
      );

      // åŒæ—¶è®¡ç®—å¦ä¸€ç§æ–¹å¼ç”¨äºå¯¹æ¯”
      const otherMethod = method === 'separate' ? 'combined' : 'separate';
      const otherResult = calculateBonusTax(
        bonusValidation.value,
        otherMethod,
        method === 'combined' ? 0 : Number(annualIncome) || 0
      );

      // æ˜¾ç¤ºç»“æœ
      displayResults(result, otherResult);

      // ä¿å­˜å†å²
      saveToHistory('bonus-tax', {
        bonus: bonusValidation.value,
        annualIncome: method === 'combined' ? Number(annualIncome) : 0,
        method,
        result
      });
    }

    function displayResults(result, otherResult) {
      // æ˜¾ç¤ºä¸»è¦ç»“æœ
      const resultData = {
        tax: {
          label: 'åº”çº³ç¨é¢',
          value: formatCurrency(result.tax) + ' å…ƒ',
          highlight: true
        },
        afterTax: {
          label: 'ç¨åæ”¶å…¥',
          value: formatCurrency(result.afterTax) + ' å…ƒ'
        },
        rate: {
          label: 'é€‚ç”¨ç¨ç‡',
          value: formatPercent(result.rate)
        }
      };

      document.getElementById('result-card').innerHTML = createResultCard(
        result.method === 'separate' ? 'å•ç‹¬è®¡ç¨ç»“æœ' : 'å¹¶å…¥ç»¼åˆæ‰€å¾—ç»“æœ',
        resultData
      );

      // æ˜¾ç¤ºå¯¹æ¯”
      const headers = ['è®¡ç¨æ–¹å¼', 'åº”çº³ç¨é¢', 'ç¨åæ”¶å…¥', 'æ¨è'];
      const currentLabel = result.method === 'separate' ? 'å•ç‹¬è®¡ç¨' : 'å¹¶å…¥ç»¼åˆæ‰€å¾—';
      const otherLabel = otherResult.method === 'separate' ? 'å•ç‹¬è®¡ç¨' : 'å¹¶å…¥ç»¼åˆæ‰€å¾—';
      
      const recommended = result.tax < otherResult.tax;
      const rows = [
        {
          cells: [
            currentLabel,
            formatCurrency(result.tax) + ' å…ƒ',
            formatCurrency(result.afterTax) + ' å…ƒ',
            recommended ? 'âœ“ æ¨è' : ''
          ],
          recommended
        },
        {
          cells: [
            otherLabel,
            formatCurrency(otherResult.tax) + ' å…ƒ',
            formatCurrency(otherResult.afterTax) + ' å…ƒ',
            !recommended ? 'âœ“ æ¨è' : ''
          ],
          recommended: !recommended
        }
      ];

      document.getElementById('comparison-card').innerHTML = `
        <div class="card">
          <h3 class="card-title">ä¸¤ç§æ–¹å¼å¯¹æ¯”</h3>
          ${createComparisonTable(headers, rows)}
          <p style="margin-top: 15px; color: var(--text-muted); font-size: 0.9rem;">
            ğŸ’¡ å»ºè®®é€‰æ‹©ç¨é¢è¾ƒä½çš„è®¡ç¨æ–¹å¼
          </p>
        </div>
      `;

      // æ˜¾ç¤ºè¯¦ç»†è®¡ç®—è¿‡ç¨‹
      const detailsHTML = createDetailsList(result.steps.map(step => ({
        label: step.label,
        value: typeof step.value === 'number' ? formatCurrency(step.value) : step.value,
        formula: step.formula
      })));

      document.getElementById('details-card').innerHTML = createCollapsible(
        'è¯¦ç»†è®¡ç®—è¿‡ç¨‹',
        `<div class="card">${detailsHTML}</div>`,
        false
      );

      document.getElementById('result-container').style.display = 'block';
      showMessage('success', 'è®¡ç®—å®Œæˆ');
    }

    function clearForm() {
      document.getElementById('bonus').value = '';
      document.getElementById('annualIncome').value = '';
      document.getElementById('method-separate').checked = true;
      document.getElementById('result-container').style.display = 'none';
      clearAllInputErrors();
    }
  </script>
</body>
</html>
